<html>
<script src='https://d3js.org/d3.v5.min.js'></script>
<link href="css/styles.css" rel="stylesheet" type="text/css" media="all">

<body onload='narrativeload()'>

    <div id="title">Title</div>
    <div id="navigation">
        <input type="button" value="<" onclick="bscene()" />
        <input type="button" value="1" onclick="changescene(1)" />
        <input type="button" value="2" onclick="changescene(2)" />
        <input type="button" value="3" onclick="changescene(3)" />
        <input type="button" value=">" onclick="fscene()" />
    </div>
    <div id="annotation">Anotation</div>
    <div id="graph"><svg height="400" width="400"></svg></div>
    <div id="instruction">Instructions</div>
    <div id="credit">We will use the data from the <a href="http://www.worldbank.org/en/research/brief/World-Panel-Income-Distribution" target="_blank">Lakner-Milanovic 2013 World Panel Income Distribution (LM-WPID)</a>.</div>
    <script>
        var pscene = 1;
        var data;
        var delephant;
        var bisect;
        var focus;
        var focusText;
        var xs;
        var ys;

        async function narrativeload() {
            delephant = await d3.csv('https://chriskabat63.github.io/narrativevisualization/data/elephant.csv');
            delephant1993 = await d3.csv('https://chriskabat63.github.io/narrativevisualization/data/elephant19932008.csv');
            delephant1998 = await d3.csv('https://chriskabat63.github.io/narrativevisualization/data/elephant19982008.csv');
            delephant2003 = await d3.csv('https://chriskabat63.github.io/narrativevisualization/data/elephant20032008.csv');
            dincbygroup = await d3.csv('https://chriskabat63.github.io/narrativevisualization/data/incbygroup.csv');

            pscene = 1;
            drawscene();
        }

        function bscene() {
            if (pscene > 1) {
                pscene--;
                drawscene()
            }
        }
        function changescene(sceneno) {
            pscene = sceneno;
            drawscene();
        }
        function fscene() {
            if (pscene < 3) {
                pscene++;
                drawscene()
            }
        }
        function drawscene() {
            //alert('drawscene:' + pscene);
            document.getElementById('title').innerHTML = 'Title: Scene ' + pscene;

            switch (pscene) {
                case 2:
                    drawelephant();
                    break;
                case 3:
                    drawallelephant();
                    break;
                default:
                    drawincomebygroup();
            }

        }

    </script>


    <script>

        async function drawincomebygroup() {

            d3.select('svg').selectAll('*').remove();

            // group the data
            var incomegroups = d3.nest()
                .key(function (d) { return d.group; })
                .entries(dincbygroup);

            xs = d3.scaleLinear().domain([1988, 2008]).range([0, 300])
            ys = d3.scaleLinear().domain([0,15000]).range([300, 0])

            // color palette
            var colors = incomegroups.map(function (d) { return d.key; }) // list of group names
            var colormap = d3.scaleOrdinal()
                .domain(colors)
                .range(d3.schemeCategory10)

            d3.select('svg')
                .append('g').attr("transform", "translate(50,50)")
                .selectAll('.line')
                .data(incomegroups)
                .enter()
                .append('path')
                .attr("fill", "none")
                .attr("stroke-width", 2)
                .attr("stroke", function (d) { return colormap(d.key) })
                .attr("d", function (d) {
                    return d3.line()
                        .x(function (d) { return xs(parseInt(d.bin_year)); })
                        .y(function (d) { return ys(parseFloat(d.RRinc)); })
                        (d.values)
                })


            d3.select("svg")
                .append("g").attr("transform", "translate(50,50)")
                .call(d3.axisLeft(ys).tickFormat(d3.format("~s")))

            d3.select("svg")
                .append("g").attr("transform", "translate(50,350)")
                .call(d3.axisBottom(xs).tickValues([1993,1998,2003,2008]).tickFormat(d3.format("~s")))

            //Show Title
            d3.select("svg").append("text")
                .attr("x", 400 / 2)
                .attr("y", 50)
                .attr("text-anchor", "middle")
                .style("font-size", "16px")
                .text("Income by Year and Decile Group");

            //X Axis
            d3.select("svg").append("text")
                .attr("transform", "translate(" + (400 / 2) + " ," + (400 - 10) + ")")
                .style("text-anchor", "middle")
                .text("Year");

            //Y Axis
            d3.select("svg").append("text")
                .attr("transform", "rotate(-90)")
                .attr("x", -(400 / 2))
                .attr("y", 15)
                .style("text-anchor", "middle")
                .text("Income");

        }
    </script>

    <script>
        async function drawelephant() {

            document.getElementById('instruction').innerHTML = "<Strong>RRinc</Strong> is a measure of the average annual income of an individual in this country in this income decile group. The units are 2005 PPP which corresponds approximately to US dollars in the year 2005.";
            document.getElementById('annotation').innerHTML = "This report shows the quantile change in RRinc in 2008 relative to RRinc in 1988 across the globe.  The highlighted area shows the quantiles that show the least gain";

            d3.select('svg').selectAll('*').remove();

            xs = d3.scaleLinear().domain([0, 19]).range([0, 300])
            ys = d3.scaleLinear().domain([0, 1]).range([300, 0])

            var line = d3.line()
                .x(function (d) { return xs(d.quintile); })
                .y(function (d) { return xy(d.RRinc); })
                .curve(d3.curveBasis);

            d3.select('svg')
                .append('g').attr("transform", "translate(50,50)")
                .append('path')
                .datum(delephant)
                .attr("fill", "none")
                .attr("stroke", "Grey")
                .attr("stroke-width", 2)
                .attr("d", d3.line()
                    .x(function (d) { return xs(parseInt(d.quintile)) })
                    .y(function (d) { return ys(parseFloat(d.RRinc)) })
                )

            d3.select("svg")
                .append("g").attr("transform", "translate(50,50)")
                .call(d3.axisLeft(ys).tickValues([0,1]).tickFormat(d3.format("~s")))

            d3.select("svg")
                .append("g").attr("transform", "translate(50,350)")
                .call(d3.axisBottom(xs).tickFormat(d3.format("~s")))

            //Show Title
            d3.select("svg").append("text")
                .attr("x", 400 / 2)
                .attr("y", 50)
                .attr("text-anchor", "middle")
                .style("font-size", "16px")
                .text("Elephant Chart");

            //X Axis
            d3.select("svg").append("text")
                .attr("transform", "translate(" + (400 / 2) + " ," + (400 - 10) + ")")
                .style("text-anchor", "middle")
                .text("Global Income Distribution");

            //Y Axis
            d3.select("svg").append("text")
                .attr("transform", "rotate(-90)")
                .attr("x", -(400 / 2))
                .attr("y", 15)
                .style("text-anchor", "middle")
                .text("Income Growth %");

            // This allows to find the closest X index of the mouse:
            bisect = d3.bisector(function (d) { return d.quintile; }).left;

            // show the area of less income growth
            focus = d3.select("svg")
                .append('g')
                .append('rect')
                .style("fill", "solid")
                .attr("stroke", "yellow")
                .attr('x', xs(14)+50)
                .attr('y', ys(.28)+75)
                .attr('width', 75)
                .attr('height', 75)
                .style("opacity", .2)

            // Create the circle that travels along the curve of chart
            focus = d3.select("svg")
                .append('g')
                .append('circle')
                .style("fill", "none")
                .attr("stroke", "black")
                .attr('r', 8.5)
                .style("opacity", 0)

            // Create the text that travels along the curve of chart
           focusText = d3.select("svg")
                .append('g')
                .append('text')
                .style("opacity", 0)
                .attr("text-anchor", "left")
                .attr("alignment-baseline", "middle")

            // Create a rect on top of the svg area: this rectangle recovers mouse position
            d3.select("svg")
                .append('g').attr("transform", "translate(50,50)")
                .append('rect')
                .style("fill", "none")
                .style("pointer-events", "all")
                .attr('width', 300)
                .attr('height', 300)
                .on('mouseover', mouseover)
                .on('mousemove', mousemove)
                .on('mouseout', mouseout);


        }

        async function drawallelephant() {

            document.getElementById('instruction').innerHTML = "<Strong>RRinc</Strong> is a measure of the average annual income of an individual in this country in this income decile group. The units are 2005 PPP which corresponds approximately to US dollars in the year 2005.";
            document.getElementById('annotation').innerHTML = "This report shows the quantile change in RRinc in 2008 relative to RRinc in 1988 across the globe.  The highlighted area shows the quantiles that show the least gain";

            d3.select('svg').selectAll('*').remove();

            xs = d3.scaleLinear().domain([0, 19]).range([0, 300])
            ys = d3.scaleLinear().domain([0, 1]).range([300, 0])

            var line = d3.line()
                .x(function (d) { return xs(d.quintile); })
                .y(function (d) { return xy(d.RRinc); })
                .curve(d3.curveBasis);

            d3.select('svg')
                .append('g').attr("transform", "translate(50,50)")
                .append('path')
                .datum(delephant)
                .attr("fill", "none")
                .attr("stroke", "Grey")
                .attr("stroke-width", 2)
                .attr("d", d3.line()
                    .x(function (d) { return xs(parseInt(d.quintile)) })
                    .y(function (d) { return ys(parseFloat(d.RRinc)) })
                )

            d3.select('svg')
                .append('g').attr("transform", "translate(50,50)")
                .append('path')
                .datum(delephant1993)
                .attr("fill", "none")
                .attr("stroke", "Red")
                .attr("stroke-width", 2)
                .attr("d", d3.line()
                    .x(function (d) { return xs(parseInt(d.quintile)) })
                    .y(function (d) { return ys(parseFloat(d.RRinc)) })
            )
            d3.select('svg')
                .append('g').attr("transform", "translate(50,50)")
                .append('path')
                .datum(delephant1998)
                .attr("fill", "none")
                .attr("stroke", "Black")
                .attr("stroke-width", 2)
                .attr("d", d3.line()
                    .x(function (d) { return xs(parseInt(d.quintile)) })
                    .y(function (d) { return ys(parseFloat(d.RRinc)) })
            )
            d3.select('svg')
                .append('g').attr("transform", "translate(50,50)")
                .append('path')
                .datum(delephant2003)
                .attr("fill", "none")
                .attr("stroke", "Yellow")
                .attr("stroke-width", 2)
                .attr("d", d3.line()
                    .x(function (d) { return xs(parseInt(d.quintile)) })
                    .y(function (d) { return ys(parseFloat(d.RRinc)) })
                )
            d3.select("svg")
                .append("g").attr("transform", "translate(50,50)")
                .call(d3.axisLeft(ys).tickValues([0,1]).tickFormat(d3.format("~s")))

            d3.select("svg")
                .append("g").attr("transform", "translate(50,350)")
                .call(d3.axisBottom(xs).tickFormat(d3.format("~s")))

            //Show Title
            d3.select("svg").append("text")
                .attr("x", 400 / 2)
                .attr("y", 50)
                .attr("text-anchor", "middle")
                .style("font-size", "16px")
                .text("Elephant Chart");

            //X Axis
            d3.select("svg").append("text")
                .attr("transform", "translate(" + (400 / 2) + " ," + (400 - 10) + ")")
                .style("text-anchor", "middle")
                .text("Global Income Distribution");

            //Y Axis
            d3.select("svg").append("text")
                .attr("transform", "rotate(-90)")
                .attr("x", -(400 / 2))
                .attr("y", 15)
                .style("text-anchor", "middle")
                .text("Income Growth %");

            // This allows to find the closest X index of the mouse:
            bisect = d3.bisector(function (d) { return d.quintile; }).left;

            // show the area of less income growth
            focus = d3.select("svg")
                .append('g')
                .append('rect')
                .style("fill", "solid")
                .attr("stroke", "yellow")
                .attr('x', xs(14)+50)
                .attr('y', ys(.28)+75)
                .attr('width', 75)
                .attr('height', 75)
                .style("opacity", .2)

            // Create the circle that travels along the curve of chart
            focus = d3.select("svg")
                .append('g')
                .append('circle')
                .style("fill", "none")
                .attr("stroke", "black")
                .attr('r', 8.5)
                .style("opacity", 0)

            // Create the text that travels along the curve of chart
           focusText = d3.select("svg")
                .append('g')
                .append('text')
                .style("opacity", 0)
                .attr("text-anchor", "left")
                .attr("alignment-baseline", "middle")

            // Create a rect on top of the svg area: this rectangle recovers mouse position
            d3.select("svg")
                .append('g').attr("transform", "translate(50,50)")
                .append('rect')
                .style("fill", "none")
                .style("pointer-events", "all")
                .attr('width', 300)
                .attr('height', 300)
                .on('mouseover', mouseover)
                .on('mousemove', mousemove)
                .on('mouseout', mouseout);


        }

        // What happens when the mouse move -> show the annotations at the right positions.
        function mouseover() {
            focus.style("opacity", 1)
            focusText.style("opacity", 1)
        }

        function mousemove() {
            // recover coordinate we need
            var x0 = xs.invert(d3.mouse(this)[0]);

            var i = bisect(delephant, x0, 0);
            selectedData = delephant[i]

            var flipsign = 1;
            if (i >= 10) { flipsign = -1}

            focus
                .attr("cx",xs(selectedData.quintile) + 50)
                .attr("cy",ys(selectedData.RRinc) + 50)
            focusText
                .html("Quintile:" + selectedData.quintile + "-RRinc:" + Math.round(selectedData.RRinc*100)/100)
                .attr("x", xs(selectedData.quintile) + (65*flipsign))
                .attr("y", ys(selectedData.RRinc) + 50)
        }
        function mouseout() {
            focus.style("opacity", 0)
            focusText.style("opacity", 0)
        }

    </script>

</body>
</html>
